// Generated by CoffeeScript 1.4.0
(function() {
  var BALLOON_OFFSET, INIT_LATITUDE, INIT_LONGTITUDE, Item, Map, SEARCH_ZOOM_LEVEL, Spot, Spots, USER_ID, api_url, load_address, load_mmc_location, read_user_follow_items, resizeContentHeight, search_item;

  $(document).ready(function() {
    resizeContentHeight();
    $(window).bind("resize", resizeContentHeight);
    $('#item-pickup-target').bind('change', function() {
      search_item($('#item-pickup-target').val(), $('#item-pickup-category').val(), $('#item-pickup-input').val());
      return false;
    });
    $('#item-pickup-category').bind('change', function() {
      search_item($('#item-pickup-target').val(), $('#item-pickup-category').val(), $('#item-pickup-input').val());
      return false;
    });
    $('#item-pickup-form').bind('submit', function() {
      search_item($('#item-pickup-target').val(), $('#item-pickup-category').val(), $('#item-pickup-input').val());
      return false;
    });
    $('#mmc-location-button').bind('click', function() {
      return load_mmc_location();
    });
    $('#location-search').bind('submit', function() {
      load_address($('#address-input').val());
      return false;
    });
    load_mmc_location();
    return $('#clear_select').hide();
  });

  load_mmc_location = function() {
    return Map.get().load();
  };

  resizeContentHeight = function() {
    var contentsHeight;
    contentsHeight = window.innerHeight - $('.navbar').height() - 30;
    if (contentsHeight < 0) {
      contentsHeight = 0;
    }
    $('#map_canvas').height(contentsHeight);
    return $('#search-result').height(contentsHeight);
  };

  load_address = function(address) {
    var geocoder;
    geocoder = new google.maps.Geocoder();
    return geocoder.geocode({
      address: address
    }, function(results, status) {
      var latlng, m;
      if (status === google.maps.GeocoderStatus.OK) {
        latlng = results[0].geometry.location;
        m = Map.get(latlng);
        m.gmap.setZoom(SEARCH_ZOOM_LEVEL);
        return m.load();
      } else {
        return alert("Geocode failed: " + status);
      }
    });
  };

  api_url = function(endpoint) {
    var api_url_base;
    api_url_base = "http://tab.do/api/1/";
    return "" + api_url_base + endpoint + ".json";
  };

  read_user_follow_items = function(cb) {
    var url;
    url = api_url("users/" + USER_ID + "/items");
    return $.get(url, {}, cb);
  };

  search_item = function(target, category, word) {
    Map.get().update(target, category, word);
    return true;
  };

  Map = (function() {
    var _instance;

    _instance = void 0;

    Map.get = function(latlng) {
      if (latlng == null) {
        latlng = new google.maps.LatLng(INIT_LATITUDE, INIT_LONGTITUDE);
      }
      if (_instance != null) {
        _instance.setCenter(latlng);
      } else {
        _instance = new Map(latlng);
      }
      return _instance;
    };

    Map.prototype.setCenter = function(latlng) {
      return this.gmap.setCenter(latlng);
    };

    function Map(latlng, zoom) {
      var myOptions;
      if (zoom == null) {
        zoom = SEARCH_ZOOM_LEVEL;
      }
      myOptions = {
        zoom: zoom,
        center: latlng,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        scrollwheel: false
      };
      this.gmap = new google.maps.Map(document.getElementById('map_canvas'), myOptions);
      this.spots = new Spots(this.gmap);
      this.loaded_data = null;
    }

    Map.prototype.load = function(latlng) {
      var read_nearby_popular_with_current_map_range, result_div,
        _this = this;
      if (latlng == null) {
        latlng = this.gmap.getCenter();
      }
      result_div = $('#search-result');
      result_div.empty();
      result_div.html("<div class='loading-text'>Loading...</div>");
      read_nearby_popular_with_current_map_range = function() {
        var bounds, dist;
        bounds = _this.gmap.getBounds();
        if (bounds != null) {
          console.log(bounds.toString());
          dist = google.maps.geometry.spherical.computeDistanceBetween(bounds.getNorthEast(), bounds.getSouthWest());
          return read_user_follow_items(function(data) {
            _this.loaded_data = data;
            return _this.update();
          });
        } else {
          return setTimeout(read_nearby_popular_with_current_map_range, 1000);
        }
      };
      return read_nearby_popular_with_current_map_range();
    };

    Map.prototype.update = function(target, category, word) {
      var bDescription, bTitle, item, item_instance, result_div, _i, _len, _ref,
        _this = this;
      if (target == null) {
        target = ".*";
      }
      if (category == null) {
        category = ".*";
      }
      if (word == null) {
        word = ".*";
      }
      result_div = $('#search-result');
      result_div.empty();
      this.clear();
      if (!(this.loaded_data != null)) {
        return;
      }
      _ref = this.loaded_data.items;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        item = _ref[_i];
        item_instance = new Item(item);
        bTitle = item.title.match(new RegExp(target)) && item.title.match(new RegExp(category)) && item.title.match(new RegExp(word));
        bDescription = item.description.match(new RegExp(target)) && item.description.match(new RegExp(category)) && item.description.match(new RegExp(word));
        if (!(bTitle || bDescription)) {
          continue;
        }
        result_div.append(item_instance.html());
        this.spots.addSpot(item_instance);
        this.spots.placeMarkers();
      }
      return $('.item_title').bind('click', function(event) {
        var spot_id;
        spot_id = $(event.currentTarget).parents("li.entry").data('spot-id');
        return _this.spots.spots[spot_id].balloonFn();
      });
    };

    Map.prototype.clear = function() {
      var item, _i, _len, _ref;
      _ref = this.loaded_data.items;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        item = _ref[_i];
        if (item.infoWindow != null) {
          item.infoWindow.close();
          item.infoWindow = null;
        }
      }
      return this.spots.clear;
    };

    return Map;

  })();

  Item = (function() {
    var truncate;

    function Item(item) {
      this.item = item;
    }

    Item.prototype.renderContext = function() {
      var item_img_m, item_img_s, now, passedDate, spot_id, spot_name, updated_at;
      updated_at = new Date(this.item.updated_at);
      now = new Date();
      passedDate = (now - updated_at) / (1000 * 60 * 60 * 24);
      item_img_s = "";
      item_img_m = "";
      if (this.item.image_urls[0] != null) {
        item_img_s = this.item.image_urls[0].crop_S;
      }
      if (this.item.image_urls[0] != null) {
        item_img_m = this.item.image_urls[0].crop_M;
      }
      spot_id = 0;
      spot_name = "";
      if (this.item.places[0] != null) {
        spot_id = this.item.places[0].id;
      }
      if (this.item.places[0] != null) {
        spot_name = this.item.places[0].name;
      }
      return {
        id: this.item.id,
        short_title: truncate(this.item.title, 20),
        title: this.item.title,
        short_description: truncate(this.item.description, 50),
        long_description: truncate(this.item.description, 300),
        image_url_small: item_img_s,
        image_url: item_img_m,
        profile_image_url: this.item.user.profile_image_url.crop_S,
        tab_url: "https://tab.do/items/" + this.item.id,
        stream_url: "https://tab.do/streams/" + this.item.stream.id,
        stream_title: this.item.stream.title,
        is_new: passedDate < 1,
        spot_id: spot_id,
        spot_name: spot_name
      };
    };

    Item.prototype.html = function() {
      var template;
      template = Handlebars.compile($('#entry-template').html());
      return template(this.renderContext());
    };

    Item.prototype.latlng = function() {
      var place;
      if (this.item.places.length > 0) {
        place = this.item.places[0];
        return new google.maps.LatLng(place.lat, place.lon);
      }
    };

    truncate = function(string, maxchars) {
      if (!(string != null)) {
        "";

      }
      if (string.length <= maxchars || maxchars <= 3) {
        return string;
      } else {
        return string.slice(0, maxchars - 3) + '...';
      }
    };

    return Item;

  })();

  SEARCH_ZOOM_LEVEL = 16;

  USER_ID = 47009;

  INIT_LATITUDE = 35.457611;

  INIT_LONGTITUDE = 139.633296;

  BALLOON_OFFSET = -110;

  Spot = (function() {

    function Spot(name, latlng) {
      this.name = name;
      this.count = 1;
      this.latlng = latlng;
      this.marker = null;
      this.balloon = null;
      this.balloonFn = null;
      this.IsBalloonOpened = true;
    }

    Spot.prototype.renderContext = function() {
      return {
        spot_name: this.name,
        spot_count: this.count
      };
    };

    Spot.prototype.infoHtml = function() {
      var template;
      template = Handlebars.compile($('#info-window-template').html());
      return template(this.renderContext());
    };

    Spot.prototype.createInfoHtml = function() {
      return this.balloon = new google.maps.InfoWindow({
        content: this.infoHtml()
      });
    };

    return Spot;

  })();

  Spots = (function() {

    function Spots(gmap) {
      this.spots = [];
      this.gmap = gmap;
    }

    Spots.prototype.addSpot = function(item) {
      var id, latlng;
      latlng = item.latlng();
      id = item.item.places[0].id;
      if (latlng != null) {
        if (!(this.spots[id] != null)) {
          return this.spots[id] = new Spot(item.item.places[0].name, latlng);
        } else {
          return this.spots[id].count++;
        }
      }
    };

    Spots.prototype.placeMarkers = function() {
      var key, spot, _ref, _results;
      _ref = this.spots;
      _results = [];
      for (key in _ref) {
        spot = _ref[key];
        spot.marker = new google.maps.Marker({
          position: spot.latlng,
          map: this.gmap
        });
        spot.createInfoHtml();
        _results.push(this.bindBalloonToMarker(key));
      }
      return _results;
    };

    Spots.prototype.bindBalloonToMarker = function(index) {
      var spot,
        _this = this;
      spot = this.spots[index];
      spot.balloonFn = function() {
        var hiddenSpot, key, showSpot, _ref, _ref1;
        if (spot.IsBalloonOpened) {
          _ref = _this.spots;
          for (key in _ref) {
            hiddenSpot = _ref[key];
            if (key !== index) {
              hiddenSpot.marker.setVisible(false);
            }
          }
          $('.entry').each(function() {
            var id;
            id = $(this).data("spot-id");
            if (id !== parseInt(index)) {
              return $(this).hide();
            }
          });
          spot.balloon.open(_this.gmap, spot.marker);
          spot.IsBalloonOpened = false;
          $('#clear_select').show(500);
          return $('#clear_select').bind('click', function(event) {
            return _this.clearSelect();
          });
        } else {
          _ref1 = _this.spots;
          for (key in _ref1) {
            showSpot = _ref1[key];
            showSpot.marker.setVisible(true);
          }
          $('.entry').each(function() {
            return $(this).show();
          });
          spot.balloon.close();
          spot.IsBalloonOpened = true;
          return $('#clear_select').hide();
        }
      };
      return google.maps.event.addListener(spot.marker, 'click', spot.balloonFn);
    };

    Spots.prototype.clearSelect = function() {
      var key, spot, _base, _ref;
      _ref = this.spots;
      for (key in _ref) {
        spot = _ref[key];
        if (typeof (_base = spot.balloon).close === "function") {
          _base.close();
        }
        spot.IsBalloonOpened = true;
        spot.marker.setVisible(true);
      }
      $('.entry').each(function() {
        return $(this).show();
      });
      return $('#clear_select').hide();
    };

    Spots.prototype.clear = function() {
      var spot, _i, _len, _ref, _results;
      _ref = this.spots;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        spot = _ref[_i];
        _results.push(spot.marker.setMap(null));
      }
      return _results;
    };

    return Spots;

  })();

}).call(this);
